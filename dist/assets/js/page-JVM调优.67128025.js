(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{732:function(a,t,s){"use strict";s.r(t);var n=s(1),e=Object(n.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[s("a",{attrs:{href:"https://github.com/lxchinesszz/learn-example/blob/master/learn-jvm/src/test/java/learn/jvm",target:"_blank",rel:"noopener noreferrer"}},[a._v("示例代码地址"),s("OutboundLink")],1)]),a._v(" "),s("h2",{attrs:{id:"一、jvm内存介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、jvm内存介绍"}},[a._v("#")]),a._v(" 一、JVM内存介绍")]),a._v(" "),s("p",[a._v("我们在学习JVM的内存管理的时候,我们的思维要跳出Java的局限。我们要这么理解。我们写的Java代码，是运行在JVM上的。\n如果让你来实现JVM那么。你会怎么处理呢?")]),a._v(" "),s("ul",[s("li",[a._v("公共部分(堆heap)\n"),s("ul",[s("li",[s("code",[a._v("Class字节码")]),a._v("是公共的,是共享的,所有线程都要认识字节码。")]),a._v(" "),s("li",[s("code",[a._v("new的对象")]),a._v("是公共的,也是共享的,所有线程要都能认识这些实例对象,能读取到实例的数据。")])])]),a._v(" "),s("li",[a._v("私有部分 (栈stock)\n"),s("ul",[s("li",[a._v("Java中每个线程的执行中的代码，及代码中的局部变量等信息是私有的。每个线程之间都要维护一份。")]),a._v(" "),s("li",[a._v("JVM虚拟栈和本地方法栈。")]),a._v(" "),s("li",[a._v("代码是怎么执行的,当然是一行一行执行。那么这一行一行的代码是放在哪里的呢? 是放在栈里面的。Java代码是在JVM来执行的。\n所以这个栈，我们称为"),s("code",[a._v("JVM虚拟栈")]),a._v("。")]),a._v(" "),s("li",[a._v("JVM中有些方法是调用其他语言实现的, 会使用"),s("code",[a._v("本地方法栈")]),a._v("。")]),a._v(" "),s("li",[a._v("那么谁来读取栈里面的数据,来出栈执行呢? 这叫做"),s("code",[a._v("PC寄存区")]),a._v("。")])])])]),a._v(" "),s("h2",{attrs:{id:"_1-1-堆空间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-堆空间"}},[a._v("#")]),a._v(" 1.1 堆空间")]),a._v(" "),s("p",[s("RouterLink",{attrs:{to:"/learn/project/jvm/JVM参数配置说明/"}},[a._v("JVM参数配置说明")])],1),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654183539000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("h3",{attrs:{id:"_1-1-1-堆上信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-1-堆上信息"}},[a._v("#")]),a._v(" 1.1.1 堆上信息")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654188805000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("p",[s("code",[a._v("new")]),a._v(" 出来的对象都在堆上。当堆的内存不足，会触发gc。"),s("RouterLink",{attrs:{to:"/"}},[a._v("GC策略")]),a._v("。")],1),a._v(" "),s("h3",{attrs:{id:"_1-1-2-堆的相关配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-2-堆的相关配置"}},[a._v("#")]),a._v(" 1.1.2 堆的相关配置")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[a._v("配置参数")]),a._v(" "),s("th",{staticStyle:{"text-align":"left"}},[a._v("说明")]),a._v(" "),s("th",{staticStyle:{"text-align":"left"}},[a._v("示例")])])]),a._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-Xmx")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("设置最大堆大小。")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-Xmx3550m")]),a._v("，设置JVM最大可用内存为3550 MB。")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-Xms")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("设置JVM初始内存。")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-Xms3550m")]),a._v("，设置JVM初始内存为3550 MB。此值建议与"),s("code",[a._v("-Xmx")]),a._v("相同，避免每次垃圾回收完成后JVM重新分配内存。")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-Xmn2g")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("设置年轻代大小。")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-Xmn2g")]),a._v("，设置年轻代大小为2 GB。整个JVM内存大小=年轻代大小+年老代大小+持久代大小。持久代一般固定大小为64 MB，所以增大年轻代后，将会减小年老代大小。此值对系统性能影响较大，Sun官方推荐配置为整个堆的3/8。")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:NewRatio=n")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("设置年轻代和年老代的比值。")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:NewRatio=4")]),a._v("，设置年轻代（包括Eden和两个Survivor区）与年老代的比值（除去持久代）。如果设置为4，那么年轻代与年老代所占比值为1:4，年轻代占整个堆栈的1/5。")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:SurvivorRatio=n")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("年轻代中Eden区与两个Survivor区的比值。")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:SurvivorRatio=4")]),a._v("，设置年轻代中Eden区与Survivor区的大小比值。如果设置为4，那么两个Survivor区与一个Eden区的比值为2:4，一个Survivor区占整个年轻代的1/6。")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:MaxPermSize=n")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("设置持久代大小。(JDK8以移除)")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:MaxPermSize=16m")]),a._v("，设置持久代大小为16 MB。")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:MaxTenuringThreshold=n")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("设置垃圾最大年龄。")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:MaxTenuringThreshold=0")]),a._v("，设置垃圾最大年龄。如果设置为0，那么年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，提高了效率。如果将此值设置为较大值，那么年轻代对象会在Survivor区进行多次复制，增加了对象在年轻代的存活时间，增加在年轻代即被回收的概率。")])])])]),a._v(" "),s("h3",{attrs:{id:"_1-1-3-常见问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-3-常见问题"}},[a._v("#")]),a._v(" 1.1.3 常见问题")]),a._v(" "),s("ul",[s("li",[a._v("大对象，无法释放，导致内存移除。\n"),s("strong",[a._v("堆上的问题是比较容易排查的,可以通过工具把堆的信息给dump下来,然后就能直接定位到大对象,并通过调用链路定位到具体的代码,后面会介绍工具")])])]),a._v(" "),s("h2",{attrs:{id:"_1-2-非堆空间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-非堆空间"}},[a._v("#")]),a._v(" 1.2 非堆空间")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654188048000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("h3",{attrs:{id:"_1-2-1-非堆上的信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-非堆上的信息"}},[a._v("#")]),a._v(" 1.2.1 非堆上的信息")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654188805000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("ul",[s("li",[s("code",[a._v("Thread")]),a._v(" 配置线程的栈大小，决定了你调用链的深度。")]),a._v(" "),s("li",[s("code",[a._v("Metaspace")]),a._v(" 可加载类的信息大小")])]),a._v(" "),s("h3",{attrs:{id:"_1-2-2-相关配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-相关配置"}},[a._v("#")]),a._v(" 1.2.2 相关配置")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[a._v("配置参数")]),a._v(" "),s("th",{staticStyle:{"text-align":"left"}},[a._v("说明")]),a._v(" "),s("th",{staticStyle:{"text-align":"left"}},[a._v("示例")])])]),a._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-Xss")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("设置线程的栈大小。")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-Xss128k")]),a._v("，设置每个线程的栈大小为128 KB。"),s("strong",[a._v("说明")]),a._v(" JDK 5.0版本以后每个线程栈大小为1 MB，JDK 5.0以前版本每个线程栈大小为256 KB。请依据应用的线程所需内存大小进行调整。在相同物理内存下，减小该值可以生成更多的线程。但是操作系统对一个进程内的线程个数有一定的限制，无法无限生成，一般在3000个~5000个。")])]),a._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:MaxMetaspace=n")])]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[a._v("设置元空间大小。")]),a._v(" "),s("td",{staticStyle:{"text-align":"left"}},[s("code",[a._v("-XX:MaxMetaspace=16m")]),a._v("，设置元空间大小为16 MB。")])])])]),a._v(" "),s("h2",{attrs:{id:"二、工具介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、工具介绍"}},[a._v("#")]),a._v(" 二、工具介绍")]),a._v(" "),s("h2",{attrs:{id:"_2-1-原生命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-原生命令"}},[a._v("#")]),a._v(" 2.1 原生命令")]),a._v(" "),s("h2",{attrs:{id:"_2-2-二方可视化分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-二方可视化分析"}},[a._v("#")]),a._v(" 2.2 二方可视化分析")]),a._v(" "),s("h3",{attrs:{id:"_2-2-1-idea-插件visualgc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-idea-插件visualgc"}},[a._v("#")]),a._v(" 2.2.1 idea 插件VisualGC")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654189397000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654189362000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("h3",{attrs:{id:"_2-2-2-jprofile"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-jprofile"}},[a._v("#")]),a._v(" 2.2.2 JProfile")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://www.ej-technologies.com/products/jprofiler/overview.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("JProfile"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654189623000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("h3",{attrs:{id:"_2-2-3-arthas"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-3-arthas"}},[a._v("#")]),a._v(" 2.2.3 Arthas")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://arthas.aliyun.com/zh-cn/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Arthas"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("strong",[a._v("Arthas功能是比较强大的,非常适合用于排查些疑难问题")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654189757000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("h2",{attrs:{id:"_2-3-gc日志学习"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-gc日志学习"}},[a._v("#")]),a._v(" 2.3 GC日志学习")]),a._v(" "),s("ul",[s("li",[a._v("开启GC日志参数 "),s("code",[a._v("-XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCDateStamps")])])]),a._v(" "),s("h3",{attrs:{id:"_2-3-1-年轻代gc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-1-年轻代gc"}},[a._v("#")]),a._v(" 2.3.1 年轻代GC")]),a._v(" "),s("ul",[s("li",[a._v("首先是年轻代GC")])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("2022-06-03T00:13:48.801-0800: \n0.369: \n[GC (Allocation Failure) \n[PSYoungGen: 7168K->1513K(8704K)] 7168K->4097K(49664K), 0.0183816 secs] \n[Times: user=0.02 sys=0.01, real=0.02 secs] \n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("ul",[s("li",[s("code",[a._v("2022-06-03T00:13:48.801-0800")]),a._v(" -XX:+PrintGCDateStamps 打印日期")]),a._v(" "),s("li",[s("code",[a._v("0.369")]),a._v(" -XX:+PrintGCDateStamps JVM启动到当前日期的总时长的时间戳形式")]),a._v(" "),s("li",[s("code",[a._v("[GC (Allocation Failure)")]),a._v(" GC 原因(Allocation Failure) 分配失败\n"),s("ul",[s("li",[s("mark",[a._v("Allocation Failure")]),a._v(" 分配失败")]),a._v(" "),s("li",[s("mark",[a._v("Metadata GC Threshold")]),a._v(" 元空间不足")]),a._v(" "),s("li",[s("mark",[a._v("Last ditch collection")]),a._v(" 元空间GC后,仍然不足,即触发")])])]),a._v(" "),s("li",[s("code",[a._v("PSYoungGen")]),a._v(" 年轻代GC")]),a._v(" "),s("li",[s("code",[a._v("Times")]),a._v(" 耗时统计\n"),s("ul",[s("li",[s("code",[a._v("user")]),a._v(" 表示GC线程执行所使用的CPU总时间")]),a._v(" "),s("li",[s("code",[a._v("sys")]),a._v(" 进程在内核态消耗的CPU时间")]),a._v(" "),s("li",[s("code",[a._v("real")]),a._v(" 程序从开始到结束所用的时钟时间,这个时间接近 sys + user")])])])]),a._v(" "),s("p",[s("strong",[a._v("由于多核的原因,一般的GC事件中, real time是小于sys + user time的,因为一般是多个线程并发的去做GC,所以real time是要小于systuser time的")])]),a._v(" "),s("h3",{attrs:{id:"_2-3-2-老年代gc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-2-老年代gc"}},[a._v("#")]),a._v(" 2.3.2 老年代GC")]),a._v(" "),s("p",[a._v("老年代执行的是 Full GC，Full GC执行的时候，不止回收老年代，还会回收新生代和元数据空间")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("2022-06-03T00:22:27.829-0800:\n0.798: \n[Full GC (Allocation Failure) \n[PSYoungGen: 0K->0K(8704K)] \n[ParOldGen: 36024K->36006K(40960K)] 36024K->36006K(49664K), \n[Metaspace: 3078K->3078K(1056768K)], 0.2006976 secs] \n[Times: user=1.11 sys=0.01, real=0.21 secs] \n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("ul",[s("li",[s("code",[a._v("2022-06-03T00:13:48.801-0800")]),a._v(" -XX:+PrintGCDateStamps 打印日期")]),a._v(" "),s("li",[s("code",[a._v("0.369")]),a._v(" -XX:+PrintGCDateStamps JVM启动到当前日期的总时长的时间戳形式")]),a._v(" "),s("li",[s("code",[a._v("[Full GC (Allocation Failure)")]),a._v(" GC 原因(Allocation Failure) 分配失败\n"),s("ul",[s("li",[s("mark",[a._v("Allocation Failure")]),a._v(" 分配失败")]),a._v(" "),s("li",[s("mark",[a._v("Metadata GC Threshold")]),a._v(" 元空间不足")]),a._v(" "),s("li",[s("mark",[a._v("Last ditch collection")]),a._v(" 元空间GC后,仍然不足,即触发")])])]),a._v(" "),s("li",[s("code",[a._v("PSYoungGen")]),a._v(" 年轻代GC")]),a._v(" "),s("li",[s("code",[a._v("ParOldGen")]),a._v(" 老年代GC")]),a._v(" "),s("li",[s("code",[a._v("Metaspace")]),a._v(" 元空间或者叫方法区GC")]),a._v(" "),s("li",[s("code",[a._v("Times")]),a._v(" 耗时统计\n"),s("ul",[s("li",[s("code",[a._v("user")]),a._v(" 表示GC线程执行所使用的CPU总时间")]),a._v(" "),s("li",[s("code",[a._v("sys")]),a._v(" 进程在内核态消耗的CPU时间")]),a._v(" "),s("li",[s("code",[a._v("real")]),a._v(" 程序从开始到结束所用的时钟时间,这个时间接近 sys + user")])])])]),a._v(" "),s("h2",{attrs:{id:"三、场景分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、场景分析"}},[a._v("#")]),a._v(" 三、场景分析")]),a._v(" "),s("h2",{attrs:{id:"_3-1-堆空间导致oom"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-堆空间导致oom"}},[a._v("#")]),a._v(" 3.1 堆空间导致OOM")]),a._v(" "),s("h3",{attrs:{id:"_3-1-1-模拟堆栈"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-模拟堆栈"}},[a._v("#")]),a._v(" 3.1.1 模拟堆栈")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("HeapOverflowTest")])]),a._v(" "),s("li",[s("code",[a._v("StackOverflowTest")])])]),a._v(" "),s("h3",{attrs:{id:"_3-1-2-现象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-现象"}},[a._v("#")]),a._v(" 3.1.2 现象")]),a._v(" "),s("ol",[s("li",[a._v("频繁进行fu gc")]),a._v(" "),s("li",[a._v("应用吞吐量下降")]),a._v(" "),s("li",[a._v("应用rt上升")]),a._v(" "),s("li",[a._v("方法调用报错"),s("strong",[a._v("OutOfMemoryError : Java heap space")])])]),a._v(" "),s("h3",{attrs:{id:"_3-1-3-解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-3-解决方案"}},[a._v("#")]),a._v(" 3.1.3 解决方案")]),a._v(" "),s("ol",[s("li",[s("code",[a._v("jps")]),a._v(" 找到应用 "),s("code",[a._v("pid")])]),a._v(" "),s("li",[a._v("把堆信息dump下来 "),s("code",[a._v("jmap -dump:format=b,file=heap.hprof ${pid}")])]),a._v(" "),s("li",[a._v("打开JProfile 打开文件,直接看到大对象是哪个。")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1654191631000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("h2",{attrs:{id:"_3-2-cpu飙升"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-cpu飙升"}},[a._v("#")]),a._v(" 3.2 CPU飙升")]),a._v(" "),s("p",[a._v("CPU飙升,可能是有线程一直在占用CPU。发生了死锁，发生了死循环之类的。这些情况是有问题的。\n但是当你的机器流量比较大时候,同样也会导致CPU飙升,此时可能就需要加机器来进行解决。或者仅限限流。下面\n只说有问题的场景,如何查看线程状态。")]),a._v(" "),s("h3",{attrs:{id:"_3-2-1-模拟异常"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-模拟异常"}},[a._v("#")]),a._v(" 3.2.1 模拟异常")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" CPU "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("while")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("h3",{attrs:{id:"_3-2-2-现象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-现象"}},[a._v("#")]),a._v(" 3.2.2 现象")]),a._v(" "),s("ul",[s("li",[a._v("系统卡顿,吞吐量下降")]),a._v(" "),s("li",[a._v("如果没有限制启动参数,可能会导致宿主机也非常卡段,引用占用了很大CPU")])]),a._v(" "),s("h3",{attrs:{id:"_3-2-3-解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-解决方案"}},[a._v("#")]),a._v(" 3.2.3 解决方案")]),a._v(" "),s("ol",[s("li",[a._v("找到那些线程在阻塞 "),s("code",[a._v("jstack $PID")])]),a._v(" "),s("li",[a._v("如下片段发现线程都是 "),s("code",[a._v("BLOCKED")]),a._v(" 状态, 调用点都在 "),s("code",[a._v("CPU.java:18")])])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('"Thread-497" #508 prio=5 os_prio=31 tid=0x00007f88f58a0000 nid=0x41903 waiting for monitor entry [0x0000000326ea5000]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n\tat java.io.PrintStream.println(PrintStream.java:735)\n\t- waiting to lock <0x00000007bce02720> (a java.io.PrintStream)\n\tat learn.jvm.CPU.lambda$main$0(CPU.java:18)\n\tat learn.jvm.CPU$$Lambda$1/189568618.run(Unknown Source)\n\tat java.lang.Thread.run(Thread.java:748)\n\n"Thread-496" #507 prio=5 os_prio=31 tid=0x00007f88f589f800 nid=0x41a03 waiting for monitor entry [0x0000000326da2000]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n\tat java.io.PrintStream.println(PrintStream.java:735)\n\t- waiting to lock <0x00000007bce02720> (a java.io.PrintStream)\n\tat learn.jvm.CPU.lambda$main$0(CPU.java:18)\n\tat learn.jvm.CPU$$Lambda$1/189568618.run(Unknown Source)\n\tat java.lang.Thread.run(Thread.java:748)\n\n"Thread-495" #506 prio=5 os_prio=31 tid=0x00007f8905034000 nid=0x41c03 waiting for monitor entry [0x0000000326c9f000]\n   java.lang.Thread.State: BLOCKED (on object monitor)\n\tat java.io.PrintStream.println(PrintStream.java:735)\n\t- waiting to lock <0x00000007bce02720> (a java.io.PrintStream)\n\tat learn.jvm.CPU.lambda$main$0(CPU.java:18)\n\tat learn.jvm.CPU$$Lambda$1/189568618.run(Unknown Source)\n\tat java.lang.Thread.run(Thread.java:748)\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br")])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("Arthas")]),a._v(" "),s("p",[a._v("当然如果你安装了 "),s("code",[a._v("Arthas")])]),a._v(" "),s("p",[a._v("你可以 "),s("code",[a._v("thread -n 3")]),a._v(" 打印出最忙的三个线程  "),s("a",{attrs:{href:"https://arthas.gitee.io/thread.html#cpu",target:"_blank",rel:"noopener noreferrer"}},[a._v("thread"),s("OutboundLink")],1),a._v(".\n直接输入cpu使用量")]),a._v(" "),s("p",[a._v("thread -b, 找出当前阻塞其他线程的线程")])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('"Thread-8" Id=19 cpuUsage=89.17% deltaTime=188ms time=17319ms RUNNABLE\n    at learn.jvm.CPU.lambda$main$0(CPU.java:13)\n    at learn.jvm.CPU$$Lambda$1/500977346.run(Unknown Source)\n    at java.lang.Thread.run(Thread.java:748)\n\n\n"Thread-1" Id=12 cpuUsage=85.62% deltaTime=180ms time=17296ms RUNNABLE\n    at learn.jvm.CPU.lambda$main$0(CPU.java:13)\n    at learn.jvm.CPU$$Lambda$1/500977346.run(Unknown Source)\n    at java.lang.Thread.run(Thread.java:748)\n\n\n"Thread-3" Id=14 cpuUsage=84.42% deltaTime=178ms time=17315ms RUNNABLE\n    at learn.jvm.CPU.lambda$main$0(CPU.java:13)\n    at learn.jvm.CPU$$Lambda$1/500977346.run(Unknown Source)\n    at java.lang.Thread.run(Thread.java:748)\n\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br")])]),s("h2",{attrs:{id:"_3-3-非堆空间导致oom"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-非堆空间导致oom"}},[a._v("#")]),a._v(" 3.3 非堆空间导致OOM")]),a._v(" "),s("h3",{attrs:{id:"_3-3-1-模拟异常"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1-模拟异常"}},[a._v("#")]),a._v(" 3.3.1 模拟异常")]),a._v(" "),s("p",[a._v("启动参数: "),s("code",[a._v("-XX:MetaspaceSize=120m -XX:MaxMetaspaceSize=120m -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/Users/liuxin/Github/learn-example/logs/gc.log")])]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MetaspaceOverflowTest")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("/**\n     * 查看元空间配置\n     * java -XX:+PrintFlagsFinal -version | grep Metaspace\n     * 方法区是JVM规范。\n     * - 永久代和元空间是实现\n     * 元空间调优规则:\n     * 1. 最大最小设置成一样大\n     * 防止内存抖动\n     *\n     * @param args -XX:MetaspaceSize=20m\n     *             -XX:MaxMetaspaceSize=20m\n     *             java.lang.OutOfMemoryError--\x3eMetaspace\n     */")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//        while (true) {")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Sleeps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Enhancer")]),a._v(" enhancer "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Enhancer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                enhancer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("setSuperclass")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MetaspaceOverflowTest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                enhancer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("setUseCache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                enhancer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("setCallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MethodInterceptor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v("\n                    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Object")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("intercept")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Object")]),a._v(" o"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Method")]),a._v(" method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" objects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MethodProxy")]),a._v(" methodProxy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("throws")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Throwable")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" methodProxy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("invokeSuper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("objects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"create InstanceKlass..."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                enhancer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//        }")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("while")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//  java.lang.OutOfMemoryError--\x3eMetaspace")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br")])]),s("h3",{attrs:{id:"_3-3-2-现象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-现象"}},[a._v("#")]),a._v(" 3.3.2 现象")]),a._v(" "),s("p",[a._v("当你收到运维告警,或者是明显感觉到系统吞吐量下降,甚至会有oom异常的时候,首先先去看下 GC日志，找到GC的原因。下面看下非堆空间溢出导致的GC日志,并配上前面的GC日志学习。来\n排查下问题。")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("CommandLine flags: -XX:CompressedClassSpaceSize=12582912 -XX:InitialHeapSize=268435456 -XX:MaxHeapSize=4294967296 -XX:MaxMetaspaceSize=20971520 -XX:MetaspaceSize=20971520 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseParallelGC \n2022-06-20T18:12:26.411-0800: 1.749: [GC (Allocation Failure) [PSYoungGen: 65536K->3006K(76288K)] 65536K->3006K(251392K), 0.0233877 secs] [Times: user=0.06 sys=0.02, real=0.02 secs] \n2022-06-20T18:12:26.960-0800: 2.298: [GC (Allocation Failure) [PSYoungGen: 68542K->3264K(141824K)] 68542K->3272K(316928K), 0.0194187 secs] [Times: user=0.08 sys=0.02, real=0.02 secs] \n2022-06-20T18:12:27.824-0800: 3.162: `[GC (Allocation Failure)` [PSYoungGen: 134336K->5264K(141824K)] 134344K->5280K(316928K), 0.0145565 secs] [Times: user=0.06 sys=0.02, real=0.01 secs] \n2022-06-20T18:12:28.526-0800: 3.864: [GC (Allocation Failure) [PSYoungGen: 136336K->6928K(272896K)] 136352K->6952K(448000K), 0.0198281 secs] [Times: user=0.09 sys=0.03, real=0.02 secs] \n2022-06-20T18:12:29.252-0800: 4.590: [GC (Metadata GC Threshold) [PSYoungGen: 187304K->8848K(272896K)] 187328K->8880K(448000K), 0.0217320 secs] [Times: user=0.10 sys=0.02, real=0.02 secs] \n2022-06-20T18:12:29.274-0800: 4.612: [Full GC (Metadata GC Threshold) [PSYoungGen: 8848K->0K(272896K)] [ParOldGen: 32K->8685K(86016K)] 8880K->8685K(358912K), [Metaspace: 20088K->20088K(1069056K)], 0.0245986 secs] [Times: user=0.10 sys=0.01, real=0.02 secs] \n2022-06-20T18:12:29.299-0800: 4.637: [GC (Last ditch collection) [PSYoungGen: 0K->0K(476160K)] 8685K->8685K(562176K), 0.0005319 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] \n2022-06-20T18:12:29.300-0800: 4.638: [Full GC (Last ditch collection) [PSYoungGen: 0K->0K(476160K)] [ParOldGen: 8685K->3731K(155648K)] 8685K->3731K(631808K), [Metaspace: 20088K->20088K(1069056K)], 0.0187273 secs] [Times: user=0.07 sys=0.01, real=0.01 secs] \n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br")])]),s("p",[a._v("从面的GC日志中我们能找到些GC原因,通过前面的学习。我们可以判断出来。")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1655720314000.png",alt:"",loading:"lazy"}})]),a._v(" "),s("p",[a._v("属于非堆空间造成的OOM。")]),a._v(" "),s("h3",{attrs:{id:"_3-3-3-解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-3-解决方案"}},[a._v("#")]),a._v(" 3.3.3 解决方案")]),a._v(" "),s("ol",[s("li",[a._v("排查看应用中是否有动态创建Class的地方")]),a._v(" "),s("li",[a._v("添加元空间大小(如果应用配置限制元空间大小,还出现了这样的问题,一般一定是程序中有bug导致)")])])])}),[],!1,null,null,null);t.default=e.exports}}]);