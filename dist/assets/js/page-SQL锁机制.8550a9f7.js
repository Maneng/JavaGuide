(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{597:function(s,a,t){"use strict";t.r(a);var n=t(1),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[t("img",{attrs:{src:"https://img.springlearn.cn/learn_c87a079fcea0d7893b03d4d57478bca7.png",alt:"",loading:"lazy"}})]),s._v(" "),t("p",[t("strong",[s._v("作者")]),s._v(": 西魏陶渊明\n"),t("strong",[s._v("博客")]),s._v(": "),t("a",{attrs:{href:"https://blog.springlearn.cn/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.springlearn.cn/"),t("OutboundLink")],1)]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("西魏陶渊明")]),s._v(" "),t("p",[s._v("莫笑少年江湖梦，谁不少年梦江湖")])]),s._v(" "),t("h2",{attrs:{id:"一、场景模拟"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、场景模拟"}},[s._v("#")]),s._v(" 一、场景模拟")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" shop\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  id "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'衣服'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'可售'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("innodb")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("charset")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" shop  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'衣服'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'可售'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> select * from shop;\n+----+--------+--------+\n| id | name   | status |\n+----+--------+--------+\n|  1 | 衣服   | 可售   |\n+----+--------+--------+\n1 row in set (0.00 sec)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("有一个X姨夫,两个用户并发操作问题")]),s._v(" "),t("p",[s._v("A先看到衣服: X加锁 -> 试衣服 -> 下单 -> 付款 -> 打包 -> X解锁\nB也相对衣服: 发现X已经被A加锁了,等待X解锁。")]),s._v(" "),t("h2",{attrs:{id:"二、锁知识"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、锁知识"}},[s._v("#")]),s._v(" 二、锁知识")]),s._v(" "),t("h3",{attrs:{id:"锁类型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁类型"}},[s._v("#")]),s._v(" 锁类型")]),s._v(" "),t("p",[s._v("a. 读锁(共享锁):\nb. 写锁(互斥锁): 如果当前写操作没有完毕,则无法进行其他的写操作。")]),s._v(" "),t("h3",{attrs:{id:"锁范围"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#锁范围"}},[s._v("#")]),s._v(" 锁范围")]),s._v(" "),t("ul",[t("li",[s._v("innodb默认行锁(开销大,加锁慢,锁范围小,易死锁,不容器锁冲突,并发度高)")]),s._v(" "),t("li",[s._v("MyISAM默认表锁(开销小,加锁块,无死锁,但是锁范围大容器锁冲突,并发度低)")])]),s._v(" "),t("ol",[t("li",[s._v("表锁(对一张表整体加锁)")]),s._v(" "),t("li",[s._v("行锁(对一行数据进行加锁)")])]),s._v(" "),t("hr"),s._v(" "),t("h2",{attrs:{id:"三、锁分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、锁分析"}},[s._v("#")]),s._v(" 三、锁分析")]),s._v(" "),t("h3",{attrs:{id:"_1-查看加锁的表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-查看加锁的表"}},[s._v("#")]),s._v(" 1. 查看加锁的表")]),s._v(" "),t("p",[t("code",[s._v("show open tables;")])]),s._v(" "),t("p",[s._v("1代表加锁")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> show open tables;\n+--------------------+---------------------------+--------+-------------+\n| Database           | Table                     | In_use | Name_locked |\n+--------------------+---------------------------+--------+-------------+\n| test               | emp                       |      0 |           0 |\n| test               | test_innodb_lock          |      0 |           0 |\n| test               | test03                    |      0 |           0 |\n| test               | teacher2                  |      0 |           0 |\n| test               | course2                   |      0 |           0 |\n| test               | book                      |      0 |           0 |\n| test               | shop                      |      1 |           0 |\n| test               | staffs                    |      0 |           0 |\n| test               | dept                      |      0 |           0 |\n+--------------------+---------------------------+--------+-------------+\n73 rows in set (0.00 sec)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h3",{attrs:{id:"_2-查看锁的严重程度"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-查看锁的严重程度"}},[s._v("#")]),s._v(" 2. 查看锁的严重程度")]),s._v(" "),t("p",[t("code",[s._v("show status like '%Table_locks%';")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> show status like '%Table_locks%';\n+-----------------------+-------+\n| Variable_name         | Value |\n+-----------------------+-------+\n| Table_locks_immediate | 79    |\n| Table_locks_waited    | 0     |\n+-----------------------+-------+\n2 rows in set (0.00 sec)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[t("strong",[s._v("Table_locks_immediate")]),s._v(" 能立马加锁\n"),t("strong",[s._v("Table_locks_waited")]),s._v(" 越大说明竞争越大")]),s._v(" "),t("p",[s._v("建议:\nTable_locks_immediate/Table_locks_waited > 5000,建议采用innodb,否则建议MyISAM。")]),s._v(" "),t("h2",{attrs:{id:"四、模拟加表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四、模拟加表锁"}},[s._v("#")]),s._v(" 四、模拟加表锁")]),s._v(" "),t("p",[t("code",[s._v("lock table 表1 read/write,表2 read/write")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("lock table shop write;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"加表读锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#加表读锁"}},[s._v("#")]),s._v(" 加表读锁")]),s._v(" "),t("p",[s._v("如A会话,对shop表加了read锁,则该会话可以对shop表进行读操作,不能进行写操作。\n并且只能读自己加锁了的表,如下面列子最shop加锁,能读shop不能写shop,不能读test03")]),s._v(" "),t("p",[t("strong",[s._v("如果对shop表加了read锁,那么只能对shop进行读,其他任何操作都不行了")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> lock table shop read;\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql> select * from shop\n    -> ;\n+----+--------+-----------+\n| id | name   | status    |\n+----+--------+-----------+\n|  1 | 衣服   | 已占用    |\n+----+--------+-----------+\n1 row in set (0.00 sec)\n\nmysql> update shop set status = '可售' where id = 1;\nERROR 1099 (HY000): Table 'shop' was locked with a READ lock and can't be updated\nmysql> select * from test03;\nERROR 1100 (HY000): Table 'test03' was not locked with LOCK TABLES\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596460128000.png",alt:"",loading:"lazy"}})]),s._v(" "),t("p",[s._v("其他B会话中,对于shop表能读不能写,但是不影响操作其他表。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596460283000.png",alt:"",loading:"lazy"}})]),s._v(" "),t("h3",{attrs:{id:"加表写锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#加表写锁"}},[s._v("#")]),s._v(" 加表写锁")]),s._v(" "),t("ul",[t("li",[s._v("会话A: lock table shop write;\n当前会话可以对加了锁的表进行任意操作;但是不能操作其他表。")]),s._v(" "),t("li",[s._v("其他会话B:\n当会话A释放了锁,B才能对这个表进行增删改查;")])]),s._v(" "),t("h2",{attrs:{id:"五、模拟加行锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#五、模拟加行锁"}},[s._v("#")]),s._v(" 五、模拟加行锁")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" linelock\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    id "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("auto_increment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    name "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("innodb")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" linelock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" linelock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" linelock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" linelock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'4'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" linelock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'5'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h3",{attrs:{id:"a窗口写操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#a窗口写操作"}},[s._v("#")]),s._v(" A窗口写操作")]),s._v(" "),t("p",[t("code",[s._v("insert into linelock(name) values('6');")])]),s._v(" "),t("p",[s._v("此时B窗口执行update更新会被锁定。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596463371000.png",alt:"",loading:"lazy"}})]),s._v(" "),t("p",[s._v("当A会话commit之后B就能继续操作了。\n"),t("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596463461000.png",alt:"",loading:"lazy"}})]),s._v(" "),t("p",[s._v("行锁是通过事务进行解锁的。")]),s._v(" "),t("h3",{attrs:{id:"行锁转表锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#行锁转表锁"}},[s._v("#")]),s._v(" 行锁转表锁")]),s._v(" "),t("p",[s._v("如果索引列进行了类型转换,则索引失效。")]),s._v(" "),t("p",[s._v("A窗口执行\n"),t("code",[s._v("update linelock set name = 'ai' where name = 3;")])]),s._v(" "),t("p",[s._v("B窗口执行\n"),t("code",[s._v("update linelock set name = 'ax' where name = 4;")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596464724000.png",alt:"",loading:"lazy"}})]),s._v(" "),t("h3",{attrs:{id:"间隙锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#间隙锁"}},[s._v("#")]),s._v(" 间隙锁")]),s._v(" "),t("p",[s._v("update linelock set name = 'x' where id > 1 and id < 8;")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596465102000.png",alt:"",loading:"lazy"}})]),s._v(" "),t("h3",{attrs:{id:"行锁分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#行锁分析"}},[s._v("#")]),s._v(" 行锁分析")]),s._v(" "),t("p",[t("code",[s._v("show status like '%innodb_row_lock%';")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> show status like '%innodb_row_lock%';\n+-------------------------------+--------+\n| Variable_name                 | Value  |\n+-------------------------------+--------+\n| Innodb_row_lock_current_waits | 1      |\n| Innodb_row_lock_time          | 207248 |\n| Innodb_row_lock_time_avg      | 34541  |\n| Innodb_row_lock_time_max      | 51605  |\n| Innodb_row_lock_waits         | 6      |\n+-------------------------------+--------+\n5 rows in set (0.00 sec)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596465415000.png",alt:"",loading:"lazy"}})]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("Variable_name")]),s._v(" "),t("th",[s._v("Value")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("Innodb_row_lock_current_waits")]),s._v(" "),t("td",[s._v("当前正在等待的锁的数量")])]),s._v(" "),t("tr",[t("td",[s._v("Innodb_row_lock_time")]),s._v(" "),t("td",[s._v("等待总时长,从系统启动到现在一共等待时间")])]),s._v(" "),t("tr",[t("td",[s._v("Innodb_row_lock_time_avg")]),s._v(" "),t("td",[s._v("平均等待时长")])]),s._v(" "),t("tr",[t("td",[s._v("Innodb_row_lock_time_max")]),s._v(" "),t("td",[s._v("最大等待时长")])]),s._v(" "),t("tr",[t("td",[s._v("Innodb_row_lock_waits")]),s._v(" "),t("td",[s._v("等待的次数")])])])]),s._v(" "),t("h3",{attrs:{id:"查询语句加锁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查询语句加锁"}},[s._v("#")]),s._v(" 查询语句加锁")]),s._v(" "),t("p",[t("code",[s._v("set autocommit=0;")]),s._v(" "),t("code",[s._v("select * from linelock for update;")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596466172000.png",alt:"",loading:"lazy"}})]),s._v(" "),t("p",[s._v("最后求关注,求订阅,谢谢你的阅读!")])])}),[],!1,null,null,null);a.default=e.exports}}]);