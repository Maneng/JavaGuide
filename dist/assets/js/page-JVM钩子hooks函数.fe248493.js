(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{672:function(s,t,n){"use strict";n.r(t);var a=n(1),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[n("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1589383784000.png",alt:"",loading:"lazy"}})]),s._v(" "),n("p",[n("strong",[s._v("作者")]),s._v(": 西魏陶渊明\n"),n("strong",[s._v("博客")]),s._v(": "),n("a",{attrs:{href:"https://blog.springlearn.cn/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.springlearn.cn/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("西魏陶渊明")]),s._v(" "),n("p",[s._v("莫笑少年江湖梦，谁不少年梦江湖")])]),s._v(" "),n("p",[s._v("什么是钩子函数,在学习钩子函数之前,小编先提一个问题。")]),s._v(" "),n("p",[n("strong",[s._v("请问在Spring中,如果JVM异常终止,Spring是如何保证会释放掉占用的资源,比如说数据库连接等资源呢?")])]),s._v(" "),n("p",[s._v("钩子函数非常简单,简单到小编只用摘抄一段Spring代码即可。走你,现在开始。")]),s._v(" "),n("h1",{attrs:{id:"问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),n("p",[n("code",[s._v("Spring")]),s._v(" 容器中 "),n("code",[s._v("Bean")]),s._v(" 在什么时候执行销毁方法?")]),s._v(" "),n("p",[s._v("我们知道在Spring中定义销毁方法有两种方式")]),s._v(" "),n("ol",[n("li",[s._v("实现 "),n("code",[s._v("DisposableBean")]),s._v(" 的 "),n("code",[s._v("destroy")]),s._v(" 方法。")]),s._v(" "),n("li",[s._v("使用 "),n("code",[s._v("@PreDestroy")]),s._v(" 注解修饰方法")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Component\npublic class DataCollectBean implements DisposableBean {\n\n    /**\n     * 第一种方法实现 DisposableBean#destroy方法\n     *\n     * @throws Exception 异常\n     */\n    @Override\n    public void destroy() throws Exception {\n        System.err.println("执行销毁方法");\n    }\n\n    /**\n     * 第二种方法使用PreDestroy注解声明销毁方法\n     */\n    @PreDestroy\n    public void customerDestroy() {\n        System.err.println("执行自定义销毁方法");\n    }\n\n\n}\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("h2",{attrs:{id:"那么在什么时候执行销毁方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#那么在什么时候执行销毁方法"}},[s._v("#")]),s._v(" 那么在什么时候执行销毁方法?")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1589471346000.png",alt:"",loading:"lazy"}})]),s._v(" "),n("ol",[n("li",[s._v("主动执行销毁bean")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("    public static void main(String[] args) {\n        ConfigurableApplicationContext run = SpringApplication.run(DemoApplication.class, args);\n        DataCollectBean bean = run.getBean(DataCollectBean.class);\n        //1. 主动销毁bean\n        run.getBeanFactory().destroyBean(bean);\n    }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("ol",{attrs:{start:"2"}},[n("li",[s._v("JVM关闭时候自动执行销毁方法。")])]),s._v(" "),n("p",[s._v("这里就要用到钩子函数了, "),n("code",[s._v("Spring")]),s._v(" 的钩子函数在 "),n("code",[s._v("AbstractApplicationContext#shutdownHook属性")])]),s._v(" "),n("p",[s._v("如果我们是SpringBoot项目我们看到在SpringApplication启动时候会注册一个钩子函数")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1589473259000.png",alt:"",loading:"lazy"}})]),s._v(" "),n("h1",{attrs:{id:"如何定义钩子函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何定义钩子函数"}},[s._v("#")]),s._v(" 如何定义钩子函数?")]),s._v(" "),n("p",[s._v("简直太简单了，没有任何学习成本。一行代码就能搞定。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('public class HooksTester {\n    public static void main(String[] args) {\n        Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {\n            @Override\n            public void run() {\n                System.out.println("钩子函数执行");\n            }\n        }));\n        //当主动关闭应用\n        while (true);\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[n("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1589471574000.png",alt:"",loading:"lazy"}})]),s._v(" "),n("h1",{attrs:{id:"触发钩子函数的场景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#触发钩子函数的场景"}},[s._v("#")]),s._v(" 触发钩子函数的场景")]),s._v(" "),n("p",[s._v("只要不是机器断电，强制kill -9 强制杀进程，都会触发。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1589473502000.png",alt:"",loading:"lazy"}})]),s._v(" "),n("h1",{attrs:{id:"钩子函数能做什么"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#钩子函数能做什么"}},[s._v("#")]),s._v(" 钩子函数能做什么？")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1589383970000.png",alt:"",loading:"lazy"}})]),s._v(" "),n("p",[s._v("正如上图所示优雅停机,在项目将要关闭时候,主动释放程序占用的资源信息,释放db连接池的连接等其他占用的资源信息。\n如果我们是 "),n("code",[s._v("Spring")]),s._v(" 项目其实我们不用自己定义钩子函数,我们只要使用Spring提供给我们的销毁方法即可。因为\nSpring定义的钩子函数中会去执行, "),n("code",[s._v("DisposableBean.destory()")]),s._v(" 和被 "),n("code",[s._v("PreDestroy")]),s._v(" 修饰的方法。")]),s._v(" "),n("p",[s._v("我们看下源码")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1589472185000.png",alt:"",loading:"lazy"}})]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('protected void doClose() {\n\t\t// Check whether an actual close attempt is necessary...\n\t\tif (this.active.get() && this.closed.compareAndSet(false, true)) {\n\t\t\tif (logger.isDebugEnabled()) {\n\t\t\t\tlogger.debug("Closing " + this);\n\t\t\t}\n\n\t\t\tLiveBeansView.unregisterApplicationContext(this);\n\n\t\t\ttry {\n\t\t\t\t// Publish shutdown event.\n\t\t\t\tpublishEvent(new ContextClosedEvent(this));\n\t\t\t}\n\t\t\tcatch (Throwable ex) {\n\t\t\t\tlogger.warn("Exception thrown from ApplicationListener handling ContextClosedEvent", ex);\n\t\t\t}\n\n\t\t\t// Stop all Lifecycle beans, to avoid delays during individual destruction.\n\t\t\tif (this.lifecycleProcessor != null) {\n\t\t\t\ttry {\n\t\t\t\t\tthis.lifecycleProcessor.onClose();\n\t\t\t\t}\n\t\t\t\tcatch (Throwable ex) {\n\t\t\t\t\tlogger.warn("Exception thrown from LifecycleProcessor on context close", ex);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Destroy all cached singletons in the context\'s BeanFactory.\n\t\t\tdestroyBeans();\n\n\t\t\t// Close the state of this context itself.\n\t\t\tcloseBeanFactory();\n\n\t\t\t// Let subclasses do some final clean-up if they wish...\n\t\t\tonClose();\n\n\t\t\t// Reset local application listeners to pre-refresh state.\n\t\t\tif (this.earlyApplicationListeners != null) {\n\t\t\t\tthis.applicationListeners.clear();\n\t\t\t\tthis.applicationListeners.addAll(this.earlyApplicationListeners);\n\t\t\t}\n\n\t\t\t// Switch to inactive.\n\t\t\tthis.active.set(false);\n\t\t}\n\t}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br")])]),n("p",[s._v("可以看到：doClose()方法会执行bean的destroy()，也会执行SmartLifeCycle的stop()方法，我们就可以通过重写这些方法来实现对象的关闭，生命周期的管理，实现平滑shutdown")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://i03piccdn.sogoucdn.com/7eac32473373b70a",alt:"",loading:"lazy"}})]),s._v(" "),n("p",[s._v("最后求关注,求订阅,谢谢你的阅读!")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1589360371000.png",alt:"",loading:"lazy"}})])])}),[],!1,null,null,null);t.default=e.exports}}]);