(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{617:function(s,a,e){"use strict";e.r(a);var n=e(1),t=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[e("img",{attrs:{src:"https://img.springlearn.cn/learn_c87a079fcea0d7893b03d4d57478bca7.png",alt:"",loading:"lazy"}})]),s._v(" "),e("p",[e("strong",[s._v("作者")]),s._v(": 西魏陶渊明\n"),e("strong",[s._v("博客")]),s._v(": "),e("a",{attrs:{href:"https://blog.springlearn.cn/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.springlearn.cn/"),e("OutboundLink")],1)]),s._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("西魏陶渊明")]),s._v(" "),e("p",[s._v("莫笑少年江湖梦，谁不少年梦江湖")])]),s._v(" "),e("h2",{attrs:{id:"创建表"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建表"}},[s._v("#")]),s._v(" 创建表")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("use")]),s._v(" test"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test03\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n a1 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n a2 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n a3 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n a4 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" test03 "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" idx_a1_a2_a3_a4"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("a2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("a3"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("a4"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("hr"),s._v(" "),e("h2",{attrs:{id:"建议一、按照复合索引顺序查询"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建议一、按照复合索引顺序查询"}},[s._v("#")]),s._v(" 建议一、按照复合索引顺序查询")]),s._v(" "),e("p",[e("strong",[s._v("需知")])]),s._v(" "),e("ol",[e("li",[s._v("如果(a,b,c,d)复合索引和查询使用的顺序全部一致,则复合索引全部使用,如果不部分一致或者跨列使用则就是部分使用.")]),s._v(" "),e("li",[s._v("where和order by拼起来也不要跨列,参考反例2和3")])]),s._v(" "),e("h3",{attrs:{id:"_1-建议"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-建议"}},[s._v("#")]),s._v(" 1. 建议")]),s._v(" "),e("ul",[e("li",[s._v("建议: 按照where后面按照顺序使用复合索引")]),s._v(" "),e("li",[s._v("建议: where 和 order by不要跨列\n"),e("code",[s._v("explain select a1,a2,a3,a4 from test03 where a1=1 and a2=2 and a3=3 and a4=4;")])])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596388059000.png",alt:"",loading:"lazy"}})]),s._v(" "),e("h3",{attrs:{id:"_2-反例1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-反例1"}},[s._v("#")]),s._v(" 2. 反例1")]),s._v(" "),e("p",[e("code",[s._v("explain select a1,a2,a3,a4 from test03 where a4=1 and a3=2 and a2=3 and a1=4;")])]),s._v(" "),e("p",[s._v("可以看到还是一样的,索引都用了，原因是sql在执行时候被sql优化器进行了调整,最后被调整成了上面的顺序写法。\n这是最理想的情况,但是实际中建议开发按照顺序来进行查询。\n"),e("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596388250000.png",alt:"",loading:"lazy"}})]),s._v(" "),e("h3",{attrs:{id:"_3-反例2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-反例2"}},[s._v("#")]),s._v(" 3. 反例2")]),s._v(" "),e("p",[e("code",[s._v("explain select a1,a2,a3,a4 from test03 where a1=1 and a2=2 and a4=4 order by a3;")])]),s._v(" "),e("ul",[e("li",[s._v("因为查询条件中复合索引跨列了(跨了a3)，所以导致只能用a1 和a2索引。索引key_len变成8了")]),s._v(" "),e("li",[s._v("索引中没有查询a3但是却用a3排序了,导致要回表查询a3\n"),e("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596388567000.png",alt:"",loading:"lazy"}})])]),s._v(" "),e("h3",{attrs:{id:"_4-反例3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-反例3"}},[s._v("#")]),s._v(" 4. 反例3")]),s._v(" "),e("p",[e("code",[s._v("explain select a1,a2,a3,a4 from test03 where a1=1 and a4=4 order by a3;")])]),s._v(" "),e("ul",[e("li",[s._v("跨了a2 a3 所以a4失效只能用a1 所以key_len只有一个\nwhere 和 order by拼接起来是否也满足复合顺序,如果不满足\n就会出现Using filesort")]),s._v(" "),e("li",[s._v("反例2中where 生效的是a1和a2，但是order by是a3。满足复合索引顺序,所以不会出现Using filesort")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596389005000.png",alt:"",loading:"lazy"}})]),s._v(" "),e("p",[e("code",[s._v("explain select a1,a2,a3,a4 from test03 where a1=1 and a4=4 order by a2,a3;")])]),s._v(" "),e("ul",[e("li",[s._v("where a1 order by a2 a3 所以不会出现上面Using fileSort\n"),e("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596389167000.png",alt:"",loading:"lazy"}})])]),s._v(" "),e("h2",{attrs:{id:"建议二、单表优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建议二、单表优化"}},[s._v("#")]),s._v(" 建议二、单表优化")]),s._v(" "),e("h3",{attrs:{id:"建表及需求sql"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建表及需求sql"}},[s._v("#")]),s._v(" 建表及需求sql")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\ncreate table book\n(\n bid int(4) primary key,\n name varchar(20) not null,\n authorid int(4) not null,\n publicid int(4) not null,\n typeid int(4) not null\n);\n\ninsert into book values(1,'tjava',1,1,2);\ninsert into book values(2,'tjava',2,1,2);\ninsert into book values(3,'tjava',3,2,1);\ninsert into book values(4,'tjava',4,2,3);\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[e("strong",[s._v("查询authorid = 1 并且 typeid 等于2或者3 然后根据typeid 排序")])]),s._v(" "),e("p",[e("code",[s._v("explain select bid from book where typeid in (2,3) and authorid = 1 order by typeid desc;")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> explain select bid from book where  typeid in (2,3) and authorid = 1  order by typeid desc;\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+\n| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                       |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+\n|  1 | SIMPLE      | book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    4 |    25.00 | Using where; Using filesort |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+\n1 row in set, 1 warning (0.00 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("可以看出来未用到索引,type是all。就是全表查询了。")]),s._v(" "),e("h3",{attrs:{id:"_1-优化1加索引"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-优化1加索引"}},[s._v("#")]),s._v(" 1. 优化1加索引")]),s._v(" "),e("p",[e("code",[s._v("alter table book add index idx_bta(bid,typeid,authorid);")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> explain select bid from book where  typeid in (2,3) and authorid = 1  order by typeid desc;\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+------------------------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra                                    |\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+------------------------------------------+\n|  1 | SIMPLE      | book  | NULL       | index | NULL          | idx_bta | 12      | NULL |    4 |    25.00 | Using where; Using index; Using filesort |\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+------------------------------------------+\n1 row in set, 1 warning (0.00 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("可以看到通过了加索引type由之前的all变成了index,说明有一点进步。但是我们看到还有一个"),e("code",[s._v("Using filesort")]),s._v(".前面我们说了出现这个\n是因为额外多了一次查询。根据sql的解析规则，第一个解析的是typeid,第二个是authorid。那么我们先对索引顺序做一个优化。")]),s._v(" "),e("h3",{attrs:{id:"_2-优化索引顺序"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-优化索引顺序"}},[s._v("#")]),s._v(" 2. 优化索引顺序")]),s._v(" "),e("p",[s._v("复合索引一旦进行了升级优化，就要删除了，否则会进行干扰。"),e("code",[s._v("drop index idx_bta on book;")])]),s._v(" "),e("p",[s._v("按照sql执行顺序来创建索引。这里我们其实也可以不创建bid，但是如果不创建bid,就要回表去查询bid,所以也建议加上。\n"),e("code",[s._v("alter table book add index idx_tab(typeid,authorid,bid);")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> explain select bid,typeid from book where  typeid in (2,3) and authorid = 1  order by typeid desc;\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------------------------------+\n| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra                                         |\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------------------------------+\n|  1 | SIMPLE      | book  | NULL       | range | idx_tab       | idx_tab | 8       | NULL |    2 |   100.00 | Using where; Backward index scan; Using index |\n+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------------------------------+\n1 row in set, 1 warning (0.00 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("可以看到已经没有了,Using filesort。")]),s._v(" "),e("h3",{attrs:{id:"_3-总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-总结"}},[s._v("#")]),s._v(" 3. 总结")]),s._v(" "),e("ul",[e("li",[s._v("索引优化不会一步到位,要多次优化。")]),s._v(" "),e("li",[s._v("索引顺序会影响查询效率,如果不知道怎么优化,建议sql执行顺序,多尝试几次不同顺序。通过看type的级别来调整。")]),s._v(" "),e("li",[s._v("type如果是range或者ref。其实就可以了。如果是index或者all就要考虑是否要进行优化。")]),s._v(" "),e("li",[s._v("in会是索引失效")])]),s._v(" "),e("h2",{attrs:{id:"建议三、多表优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建议三、多表优化"}},[s._v("#")]),s._v(" 建议三、多表优化")]),s._v(" "),e("h3",{attrs:{id:"建表及需求sql-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建表及需求sql-2"}},[s._v("#")]),s._v(" 建表及需求sql")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("create table teacher2\n(\n    tid int(4) primary key,\n    cid int(4) not null\n);\n\ninsert into teacher2 values(1,2);\ninsert into teacher2 values(2,1);\ninsert into teacher2 values(3,3);\n\ncreate table course2\n(\n    cid int(4),\n    cname varchar(20)\n);\ninsert into course2 values(1,'java');\ninsert into course2 values(2,'python');\ninsert into course2 values(3,'kotlin');\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[e("strong",[s._v("需求sql")])]),s._v(" "),e("p",[e("code",[s._v("select * from teacher2 t left outer join course2 c on t.cid=c.cid where c.cname = 'java';")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> select * from teacher2 t left outer join course2 c on t.cid=c.cid where c.cname = 'java';\n+-----+-----+------+-------+\n| tid | cid | cid  | cname |\n+-----+-----+------+-------+\n|   2 |   1 |    1 | java  |\n+-----+-----+------+-------+\n1 row in set (0.00 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("执行计划分析")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> explain select * from teacher2 t left outer join course2 c on t.cid=c.cid where c.cname = 'java';\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n|  1 | SIMPLE      | c     | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    3 |    33.33 | Using where                                        |\n|  1 | SIMPLE      | t     | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    3 |    33.33 | Using where; Using join buffer (Block Nested Loop) |\n+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+\n2 rows in set, 1 warning (0.00 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("可以看到有一个"),e("code",[s._v("Using join buffer")]),s._v("。 说明Sql写的太差了，mysql给你加了一个缓存。经过下面的索引优化会去掉。")]),s._v(" "),e("h3",{attrs:{id:"优化1小表驱动大表"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优化1小表驱动大表"}},[s._v("#")]),s._v(" 优化1小表驱动大表")]),s._v(" "),e("p",[s._v("当编写语句时候,将数据量小的表放左边(假设此时t表小,on t.cid = c.cid);反之如果c表小(on c.cid = t.tic)")]),s._v(" "),e("h3",{attrs:{id:"优化2加索引"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优化2加索引"}},[s._v("#")]),s._v(" 优化2加索引")]),s._v(" "),e("p",[s._v("索引建立在经常使用的字段上,本例中t.cid使用频繁。")]),s._v(" "),e("p",[e("code",[s._v("alter table teacher2 add index idx_teacher2_cid(cid);")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> explain select * from teacher2 t left outer join course2 c on t.cid=c.cid where c.cname = 'java';\n+----+-------------+-------+------------+------+------------------+------------------+---------+------------+------+----------+-------------+\n| id | select_type | table | partitions | type | possible_keys    | key              | key_len | ref        | rows | filtered | Extra       |\n+----+-------------+-------+------------+------+------------------+------------------+---------+------------+------+----------+-------------+\n|  1 | SIMPLE      | c     | NULL       | ALL  | NULL             | NULL             | NULL    | NULL       |    3 |    33.33 | Using where |\n|  1 | SIMPLE      | t     | NULL       | ref  | idx_teacher2_cid | idx_teacher2_cid | 4       | test.c.cid |    1 |   100.00 | Using index |\n+----+-------------+-------+------------+------+------------------+------------------+---------+------------+------+----------+-------------+\n2 rows in set, 1 warning (0.00 sec)\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("给name也加索引")]),s._v(" "),e("p",[e("code",[s._v("alter table course2 add index idx_course2_name(cname);")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> explain select * from teacher2 t left outer join course2 c on t.cid=c.cid where c.cname = 'java';\n+----+-------------+-------+------------+------+------------------+------------------+---------+------------+------+----------+-------------+\n| id | select_type | table | partitions | type | possible_keys    | key              | key_len | ref        | rows | filtered | Extra       |\n+----+-------------+-------+------------+------+------------------+------------------+---------+------------+------+----------+-------------+\n|  1 | SIMPLE      | c     | NULL       | ref  | idx_course2_name | idx_course2_name | 83      | const      |    1 |   100.00 | Using where |\n|  1 | SIMPLE      | t     | NULL       | ref  | idx_teacher2_cid | idx_teacher2_cid | 4       | test.c.cid |    1 |   100.00 | Using index |\n+----+-------------+-------+------------+------+------------------+------------------+---------+------------+------+----------+-------------+\n2 rows in set, 1 warning (0.00 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("这样两个查询就都用到了索引。")]),s._v(" "),e("h2",{attrs:{id:"建议四、sql优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建议四、sql优化"}},[s._v("#")]),s._v(" 建议四、sql优化")]),s._v(" "),e("h3",{attrs:{id:"_1-exist和in"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-exist和in"}},[s._v("#")]),s._v(" 1. exist和in")]),s._v(" "),e("p",[s._v("如果主查询的数据集大用 "),e("code",[s._v("in")]),s._v(" ,如果子查询数据量大使用 "),e("code",[s._v("exist")])]),s._v(" "),e("h3",{attrs:{id:"_2-order-by优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-order-by优化"}},[s._v("#")]),s._v(" 2. order by优化")]),s._v(" "),e("p",[s._v("Using filesort 有两种算法: 双路排序、单路排序(根据IO的次数,即访问磁盘的顺序)")]),s._v(" "),e("ul",[e("li",[s._v("MySQL4.1前默认使用双路排序,即扫描两次磁盘(1. 从磁盘读取排序字段,2. 扫描其他字段)")]),s._v(" "),e("li",[s._v("MySQL4.1后默认使用单路排序,即访问一次磁盘(1. 只读取一次字段,然后在buffer中进行排序)")])]),s._v(" "),e("p",[s._v("但是单路排序有隐患就是不一定是只访问一次磁盘,因为加入数据量特别大,则无法将所有字段的\n数据都放到buffer中,要多次分片读取。此时可以考虑调大buffer容量大小。")]),s._v(" "),e("p",[e("code",[s._v("set max_length_for_sort_data = 1024")]),s._v(" (单位/字节)")]),s._v(" "),e("p",[s._v("如果缓存区大小太小,mysql会自动从单路调整到双路。")]),s._v(" "),e("p",[e("strong",[s._v("建议")])]),s._v(" "),e("ul",[e("li",[s._v("避免使用"),e("code",[s._v("select *")])]),s._v(" "),e("li",[s._v("复合索引不要跨列使用,如果where和order尽量也按照顺序使用")]),s._v(" "),e("li",[s._v("order by 如果是多个字段,建议都是升序或者都是降序")])]),s._v(" "),e("h3",{attrs:{id:"_3-慢查询日志"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-慢查询日志"}},[s._v("#")]),s._v(" 3. 慢查询日志")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://blog.springlearn.cn/posts/3935/",target:"_blank",rel:"noopener noreferrer"}},[s._v("如何找到垃圾SQL语句,你知道这些方式吗？"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("慢sql就是mysql提供的一种日志记录,用于记录响应的时间超过阀值得语句;")]),s._v(" "),e("p",[e("strong",[s._v("查询是否开启慢查询")])]),s._v(" "),e("p",[e("code",[s._v("show variables like '%slow_query_log%';")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> show variables like '%slow_query_log%';\n+---------------------+-----------------------------------------+\n| Variable_name       | Value                                   |\n+---------------------+-----------------------------------------+\n| slow_query_log      | OFF                                     |\n| slow_query_log_file | /usr/local/var/mysql/localhost-slow.log |\n+---------------------+-----------------------------------------+\n2 rows in set (0.06 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[e("strong",[s._v("临时开启:")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("set global slow_query_log = 1;\nexit;\nservices mysql restart\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("strong",[s._v("查询慢查询日志阀值")])]),s._v(" "),e("p",[e("code",[s._v("show variables like '%long_query_time%';")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> show variables like '%long_query_time%';\n+-----------------+-----------+\n| Variable_name   | Value     |\n+-----------------+-----------+\n| long_query_time | 10.000000 |\n+-----------------+-----------+\n1 row in set (0.00 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[e("strong",[s._v("临时设置阀值")])]),s._v(" "),e("p",[s._v("修改完成之后要重新登录生效")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("set global long_query_time = 5;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> show variables like '%long_query_time%';\n+-----------------+-----------+\n| Variable_name   | Value     |\n+-----------------+-----------+\n| long_query_time | 10.000000 |\n+-----------------+-----------+\n1 row in set (0.00 sec)\n\nmysql> set global long_query_time = 5;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql> show variables like '%long_query_time%';\n+-----------------+-----------+\n| Variable_name   | Value     |\n+-----------------+-----------+\n| long_query_time | 10.000000 |\n+-----------------+-----------+\n1 row in set (0.00 sec)\n\nmysql> exit\nBye\n liuxin@localhost  ~  mysql -u root -p\nEnter password:\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 9\nServer version: 8.0.16 Homebrew\n\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\n\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nmysql> show variables like '%long_query_time%';\n+-----------------+----------+\n| Variable_name   | Value    |\n+-----------------+----------+\n| long_query_time | 5.000000 |\n+-----------------+----------+\n1 row in set (0.00 sec)\n\nmysql>\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br")])]),e("h4",{attrs:{id:"超过阀值得数量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#超过阀值得数量"}},[s._v("#")]),s._v(" 超过阀值得数量")]),s._v(" "),e("p",[e("code",[s._v("show global status like '%slow_queries%';")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> show global status like '%slow_queries%';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Slow_queries  | 0     |\n+---------------+-------+\n1 row in set (0.01 sec)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h2",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),e("ol",[e("li",[s._v("复合索引,不要跨列或无序使用")]),s._v(" "),e("li",[s._v("复合索引,尽量使用全索引匹配")]),s._v(" "),e("li",[s._v("不要在索引上进行计算、函数、类型转换")]),s._v(" "),e("li",[s._v("复合索引不能使用 != 、 <> 、 is null")]),s._v(" "),e("li",[s._v('like尽量以"常量"开头,不要以"%"开头,否则索引失效')]),s._v(" "),e("li",[s._v("尽量不要使用类型转换（显式、隐式）,否则索引失效。where name = 'lx' 可以。where name\n"),e("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596447963000.png",alt:"",loading:"lazy"}})]),s._v(" "),e("li",[s._v("尽量不要用or,否则左右索引都可能失效\n"),e("img",{attrs:{src:"https://img.springlearn.cn/blog/learn_1596448080000.png",alt:"",loading:"lazy"}})])]),s._v(" "),e("p",[s._v("最后求关注,求订阅,谢谢你的阅读!")])])}),[],!1,null,null,null);a.default=t.exports}}]);